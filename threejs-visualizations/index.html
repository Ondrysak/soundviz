<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Three.js Audio Visualizations</title>
  <style>
    html, body { margin:0; height:100%; background:#000; color:#fff; font-family: Arial, sans-serif; }
    #app { display:flex; height:100%; }
    #sidebar { width: 320px; background:#0b0b0b; border-right:1px solid #222; padding:12px; box-sizing:border-box; overflow:auto; }
    #viewport { flex:1; position:relative; }
    #viewport canvas { display:block; width:100%; height:100%; }
    .section { margin-bottom:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    select, button, input[type="file"] { background:#111; color:#eee; border:1px solid #333; padding:6px; border-radius:4px; }
    .metrics { font-size:12px; color:#ccc; }
    .levels { display:flex; gap:4px; }
    .bar { width: 80px; height: 8px; background:#222; position:relative; }
    .bar > span { position:absolute; left:0; top:0; bottom:0; background:linear-gradient(90deg, #0ff, #f0f); width:0; }
    .footer { position:absolute; right:10px; bottom:10px; font-size:12px; color:#aaa; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.7/build/dat.gui.min.js"></script>
  <script src="./shaders/shader-loader.js"></script>
  <script src="./base-threejs-visualization.js"></script>
  <script src="./fractal-visualization.js"></script>
  <script src="./shader-visualization.js"></script>
  <script src="./particle-visualization.js"></script>
  <script src="./particle-rings-visualization.js"></script>
  <script src="./deform-geometry-visualization.js"></script>
  <script src="./plasma-shader-visualization.js"></script>
  <script src="./audio-bars3d-visualization.js"></script>
  <script src="./vertex-distortion-visualization.js"></script>
  <script src="./instanced-grid-visualization.js"></script>
  <script src="./ribbon-trails-visualization.js"></script>
  <script src="./galaxy-particles-visualization.js"></script>
  <script src="./feedback-post-visualization.js"></script>
  <script src="./torusknot-material-visualization.js"></script>

  <script src="./instancing-scatter-visualization.js"></script>

  <script src="./lensflares-visualization.js"></script>

  <script src="./spotlights-visualization.js"></script>
  <script src="./trippy-shader-visualization.js"></script>

  <script src="./mandelbrot-de-visualization.js"></script>
  <script src="./hexagon-shader-visualization.js"></script>
  <script src="./note-shape-shader-visualization.js"></script>
  <script src="./orbifold-folds-visualization.js"></script>
  <script src="./meta-pipes-visualization.js"></script>
  <script src="./lava-visualization.js"></script>





</head>
<body>
  <div id="app">
    <div id="sidebar">
      <div class="section">
        <div class="row">
          <label for="vizSelect">Visualization:</label>
          <select id="vizSelect">
            <option value="fractal">Fractal</option>
            <option value="shader">Shader</option>
            <option value="particles">Particles</option>
            <option value="rings">Particle Rings</option>
            <option value="deform">Deforming Geometry</option>
            <option value="plasma">Plasma Shader</option>
            <option value="bars3d">3D Audio Bars</option>
            <option value="vertex">Vertex Distortion</option>
            <option value="grid">Instanced Grid</option>
            <option value="ribbons">Ribbon Trails</option>
            <option value="galaxy">Galaxy Particles</option>
            <option value="feedback" selected>Feedback Post</option>
            <option value="torusknot">TorusKnot Material</option>
            <option value="scatter">Instancing Scatter</option>
            <option value="hexagon">Hex Cells</option>
            <option value="noteshape">Note Shape Shader</option>
            <option value="orbifold">Orbifold Folds</option>
            <option value="metapipes">Meta Pipes Lattice</option>
            <option value="mandelbrot">Mandelbrot DE</option>
            <option value="trippy">Trippy Shader</option>
            <option value="lava">Lava</option>
            <option value="lensflares">Lens Flares</option>
            <option value="spotlights">Spotlights</option>
          </select>
        </div>
      </div>
      <div class="section">
        <div>Audio Input</div>
        <div class="row">
          <button id="micBtn">Use Microphone</button>
          <input type="file" id="fileInput" accept="audio/*" />
        </div>
        <audio id="audioEl" controls style="width:100%; margin-top:6px;"></audio>
      </div>
      <div class="section">
        <div>Performance</div>
        <div class="metrics"><span id="fps">FPS: --</span> Â· <span id="count">Count: --</span></div>
        <div class="levels" style="margin-top:6px;">
          <div>Bass</div><div class="bar"><span id="bassBar"></span></div>
          <div>Mid</div><div class="bar"><span id="midBar"></span></div>
          <div>Treble</div><div class="bar"><span id="trebleBar"></span></div>
        </div>
        <div class="row" style="margin-top:6px;">
          <button id="fullscreenBtn">Fullscreen</button>
        </div>
      </div>
      <div id="guiContainer" class="section"></div>
      <div class="section" style="font-size:12px; color:#aaa;">
        Tips: Select an audio source (mic or file) and visualizations will react immediately. Switch visualizations anytime.
      </div>
    </div>
    <div id="viewport"></div>
  </div>

  <div class="footer">Three.js Audio Visualizations</div>

<script>
  // Audio controller
  const AudioCtrl = {
    ctx: null,
    analyser: null,
    source: null,
    smoothing: 0.8,
    fftSize: 2048,
    async useMic() {
      if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      this._connectSource(this.ctx.createMediaStreamSource(stream));
    },
    async useFile(audioEl) {
      if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      if (this.source) this.source.disconnect();
      this.source = this.ctx.createMediaElementSource(audioEl);
      this._setupAnalyser();
      this.source.connect(this.analyser);
      this.analyser.connect(this.ctx.destination);
    },
    _setupAnalyser() {
      if (!this.analyser) this.analyser = this.ctx.createAnalyser();
      this.analyser.fftSize = this.fftSize;
      this.analyser.smoothingTimeConstant = this.smoothing;
    },
    _connectSource(src) {
      if (!this.ctx) return;
      if (this.source) this.source.disconnect();
      this.source = src;
      this._setupAnalyser();
      this.source.connect(this.analyser);
      // Do not connect analyser to destination for mic to avoid feedback
    }
  };
  // File-protocol friendly adjustments
  if (!window.isSecureContext) {
    const micBtnEl = document.getElementById('micBtn');
    if (micBtnEl) {
      micBtnEl.disabled = true;
      micBtnEl.title = 'Microphone requires HTTPS or localhost. Use Audio File.';
    }
  }

  // Ensure only one MediaElementSource per <audio> element (prevents errors on reselect)
  AudioCtrl.mediaElementNode = null;
  AudioCtrl.useFile = async function(audioEl) {
    if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    if (!this.analyser) this.analyser = this.ctx.createAnalyser();
    this.analyser.fftSize = this.fftSize;
    this.analyser.smoothingTimeConstant = this.smoothing;

    if (!this.mediaElementNode) {
      this.mediaElementNode = this.ctx.createMediaElementSource(audioEl);
    }
    try { this.mediaElementNode.disconnect(); } catch (e) {}
    this.mediaElementNode.connect(this.analyser);
    try { this.analyser.disconnect(); } catch (e) {}
    this.analyser.connect(this.ctx.destination);
  };


  // Visualization management
  const viewport = document.getElementById('viewport');
  const vizSelect = document.getElementById('vizSelect');
  const micBtn = document.getElementById('micBtn');
  const fileInput = document.getElementById('fileInput');
  const audioEl = document.getElementById('audioEl');
  const fpsEl = document.getElementById('fps');
  const countEl = document.getElementById('count');
  const bassBar = document.getElementById('bassBar');
  const midBar = document.getElementById('midBar');
  const trebleBar = document.getElementById('trebleBar');
  const fullscreenBtn = document.getElementById('fullscreenBtn');

  let gui, currentViz = null;
  let fpsFrames = 0, fpsLast = performance.now();

  function makeContainer(){
    // ensure viewport has a child
    if (!viewport.firstChild){
      const div = document.createElement('div');
      div.style.position = 'absolute';
      div.style.inset = '0';
      viewport.appendChild(div);
    }
    return viewport.firstChild;
  }

  async function createViz(kind){
    if (currentViz) { currentViz.dispose(); currentViz = null; }
    const container = makeContainer();
    if (kind === 'fractal') currentViz = new FractalVisualization(container);
    else if (kind === 'shader') currentViz = new ShaderVisualization(container);
    else if (kind === 'particles') currentViz = new ParticleVisualization(container);
    else if (kind === 'rings') currentViz = new ParticleRingsVisualization(container);
    else if (kind === 'deform') currentViz = new DeformGeometryVisualization(container);
    else if (kind === 'plasma') currentViz = new PlasmaShaderVisualization(container);
    else if (kind === 'hexagon') currentViz = new HexagonShaderVisualization(container);
    else if (kind === 'noteshape') currentViz = new NoteShapeShaderVisualization(container);
    else if (kind === 'orbifold') currentViz = new OrbifoldFoldsVisualization(container);

    else if (kind === 'bars3d') currentViz = new AudioBars3DVisualization(container);
    else if (kind === 'vertex') currentViz = new VertexDistortionVisualization(container);
    else if (kind === 'trippy') currentViz = new TrippyShaderVisualization(container);
    else if (kind === 'metapipes') currentViz = new MetaPipesVisualization(container);
    else if (kind === 'mandelbrot') currentViz = new MandelbrotDEVisualization(container);
    else if (kind === 'lava') currentViz = new LavaVisualization(container);


    else if (kind === 'grid') currentViz = new InstancedGridVisualization(container);
    else if (kind === 'ribbons') currentViz = new RibbonTrailsVisualization(container);
    else if (kind === 'galaxy') currentViz = new GalaxyParticlesVisualization(container);
    else if (kind === 'feedback') currentViz = new FeedbackPostVisualization(container);
    else if (kind === 'torusknot') currentViz = new TorusKnotMaterialVisualization(container);
    else if (kind === 'scatter') currentViz = new InstancingScatterVisualization(container);
    else if (kind === 'lensflares') currentViz = new LensFlaresVisualization(container);
    else if (kind === 'spotlights') currentViz = new SpotlightsVisualization(container);
    else currentViz = new ParticleVisualization(container);

    // Wait for async initialization to complete
    await currentViz.initialize();

    if (AudioCtrl.analyser) currentViz.setAnalyser(AudioCtrl.ctx, AudioCtrl.analyser, AudioCtrl.fftSize);
    setupGUIForViz(kind);
    currentViz.start();
  }

  function setupGUIForViz(kind){
    // destroy previous gui
    if (gui) { gui.destroy(); gui = null; }
    gui = new dat.GUI({ autoPlace:false, width:300 });
    document.getElementById('guiContainer').innerHTML = '';
    document.getElementById('guiContainer').appendChild(gui.domElement);

    if (kind === 'fractal'){
      const p = currentViz.params;
      gui.add(p, 'maxDepth', 1, 8, 1).name('Max Depth');
      gui.add(p, 'hueSpeed', 0.0, 1.0, 0.01).name('Hue Speed');
      gui.add(p, 'rotationSpeed', 0.0, 2.0, 0.01).name('Rotation Speed');
      gui.add(p, 'scalePulse', 0.0, 0.5, 0.01).name('Scale Pulse');
    } else if (kind === 'shader'){
      // No parameters yet
    } else if (kind === 'particles'){
      const p = currentViz.params;
      gui.add(p, 'pattern', ['sphere','cube','cloud']).name('Pattern').onChange(()=>currentViz._rebuild(currentViz.count));
      gui.add(p, 'count', 500, 10000, 100).name('Count').onChange(v=>currentViz._rebuild(v));
      gui.add(p, 'amplitude', 0.1, 3.0, 0.1).name('Amplitude');
      gui.add(p, 'orbitSpeed', 0.0, 2.0, 0.01).name('Orbit Speed');
      gui.add(p, 'avoidance', 0.0, 2.0, 0.01).name('Avoidance');
    } else if (kind === 'rings'){
      const p = currentViz.params || {};
      gui.add(p, 'spin', 0.0, 2.0, 0.01).name('Spin');
      gui.add(p, 'waveHeight', 0.0, 2.0, 0.01).name('Wave Height');
    } else if (kind === 'trippy'){
      const p = currentViz.params || {};
      gui.add(p, 'zoom', 0.5, 2.5, 0.01).name('Zoom');
    } else if (kind === 'mandelbrot'){
      const p = currentViz.params || {};
      gui.add(p, 'centerX', -2.5, 1.5, 0.0005).name('Center X');
      gui.add(p, 'centerY', -1.5, 1.5, 0.0005).name('Center Y');
      gui.add(p, 'zoomPow', 8.0, 18.0, 0.1).name('Zoom Power');
      gui.add(p, 'speed', 0.0, 2.0, 0.01).name('Speed');
      gui.add(p, 'colorExp', 0.0, 1.0, 0.01).name('Color Exp');
      gui.add(p, 'hueShift', 0.0, 1.0, 0.001).name('Hue Shift');
    } else if (kind === 'noteshape'){
      const p = currentViz.params || {};
      const ctlThickness = gui.add(p, 'lineThickness', 0.5, 8.0, 0.05).name('Line Thickness');
      const ctlCount = gui.add(p, 'lineCount', 1, 10, 1).name('Lines');
      const ctlSpacing = gui.add(p, 'lineSpacing', 1.0, 60.0, 1.0).name('Line Spacing (px)');
      const ctlMode = gui.add(p, 'spacingMode', ['Linear','Exponential','Sinusoidal','Logarithmic']).name('Spacing Mode');
      const ctlExp = gui.add(p, 'exponentialBase', 1.2, 3.0, 0.01).name('Exp Base');
      const ctlSinF = gui.add(p, 'sinusoidFreq', 0.5, 4.0, 0.01).name('Sine Freq');
      const ctlSinA = gui.add(p, 'sinusoidAmp', 0.1, 2.0, 0.01).name('Sine Amp');
      const ctlLog = gui.add(p, 'logBase', 1.5, 10.0, 0.1).name('Log Base');
      // New: brightness, softness, offset, side, jitter
      gui.add(p, 'lineBrightness', 0.2, 2.0, 0.01).name('Line Brightness');
      gui.add(p, 'lineSoftness', 0.2, 2.0, 0.01).name('Line Softness');
      gui.add(p, 'lineOffset', -40.0, 40.0, 1.0).name('Line Offset (px)');
      const ctlSide = gui.add(p, 'lineSide', ['Both','Inside','Outside']).name('Line Side');
      gui.add(p, 'lineJitterAmp', 0.0, 12.0, 0.1).name('Jitter Amp (px)');
      gui.add(p, 'lineJitterSpeed', 0.0, 3.0, 0.01).name('Jitter Speed');
      function updateModeControls(){
        const m = p.spacingMode;
        ctlExp.domElement.parentElement.style.display = (m==='Exponential') ? '' : 'none';
        ctlSinF.domElement.parentElement.style.display = (m==='Sinusoidal') ? '' : 'none';
        ctlSinA.domElement.parentElement.style.display = (m==='Sinusoidal') ? '' : 'none';
        ctlLog.domElement.parentElement.style.display = (m==='Logarithmic') ? '' : 'none';
      }
      updateModeControls();
      ctlMode.onChange(updateModeControls);
    } else if (kind === 'orbifold'){
      const p = currentViz.params || {};
      // Quick knobs
      gui.add(p, 'scale', 0.6, 2.5, 0.01).name('Scale');
      gui.add(p, 'warp', 0.0, 1.5, 0.01).name('Warp');
      gui.add(p, 'rot', 0.0, 2.5, 0.01).name('Rotation');
      gui.add(p, 'aa', { Off:1, x2:2 }).name('Antialias');

      // Structure
      const fs = gui.addFolder('Structure');
      fs.add(p, 'warpFreq', 0.5, 8.0, 0.01).name('Warp Freq');
      fs.add(p, 'warpSpeed', 0.0, 3.0, 0.01).name('Warp Speed');
      fs.add(p, 'axisMix', 0.0, 1.0, 0.001).name('Axis Mix');
      fs.add(p, 'distCoeff', 0.05, 0.6, 0.001).name('Dist Coeff');

      // Camera
      const fc = gui.addFolder('Camera');
      fc.add(p, 'camRadius', 1.0, 6.0, 0.01).name('Radius');
      fc.add(p, 'camHeight', -2.0, 2.0, 0.01).name('Height');
      fc.add(p, 'fov', 0.5, 4.0, 0.01).name('FOV');

      // Lighting & Fog
      const fl = gui.addFolder('Lighting');
      fl.add(p, 'ambient', 0.0, 1.0, 0.001).name('Ambient');
      fl.add(p, 'key', 0.0, 2.5, 0.01).name('Key');
      fl.add(p, 'back', 0.0, 1.5, 0.01).name('Back');
      fl.add(p, 'aoExp', 0.5, 3.0, 0.01).name('AO Exp');
      fl.add(p, 'fog', 0.0, 1.0, 0.01).name('Fog');

      // Color
      const f = gui.addFolder('Color');
      f.add(p, 'hueBase', 0.0, 1.0, 0.001).name('Hue Base');
      f.add(p, 'hueRange', 0.0, 1.0, 0.001).name('Hue Range');
      f.add(p, 'hueSpeed', 0.0, 3.0, 0.01).name('Hue Speed');
    } else if (kind === 'metapipes'){
      const p = currentViz.params || {};
      // Quick knobs
      gui.add(p, 'tile', 1.2, 4.0, 0.01).name('Tile Size');
      gui.add(p, 'pipeR', 0.05, 0.6, 0.001).name('Pipe Radius');
      gui.add(p, 'aa', { Off:1, x2:2 }).name('Antialias');

      // Structure
      const fs = gui.addFolder('Structure');
      fs.add(p, 'swirl', 0.0, 2.0, 0.01).name('Swirl');
      fs.add(p, 'swirlFreq', 0.2, 4.0, 0.01).name('Swirl Freq');
      fs.add(p, 'swirlSpeed', 0.0, 3.0, 0.01).name('Swirl Speed');
      fs.add(p, 'bandFreq', 0.5, 12.0, 0.01).name('Band Freq');
      fs.add(p, 'bandStr', 0.0, 1.0, 0.01).name('Band Strength');

      // Camera
      const fc = gui.addFolder('Camera');
      fc.add(p, 'camRadius', 1.0, 6.0, 0.01).name('Radius');
      fc.add(p, 'camHeight', -2.0, 2.0, 0.01).name('Height');
      fc.add(p, 'fov', 0.5, 4.0, 0.01).name('FOV');

      // Lighting & Color
      const fl = gui.addFolder('Lighting');
      fl.add(p, 'ambient', 0.0, 1.0, 0.001).name('Ambient');
      fl.add(p, 'key', 0.0, 2.5, 0.01).name('Key');
      fl.add(p, 'back', 0.0, 1.5, 0.01).name('Back');
      fl.add(p, 'fog', 0.0, 1.0, 0.01).name('Fog');

      const fcol = gui.addFolder('Color');
      fcol.add(p, 'hueBase', 0.0, 1.0, 0.001).name('Hue Base');
      fcol.add(p, 'hueRange', 0.0, 1.0, 0.001).name('Hue Range');
      fcol.add(p, 'sat', 0.0, 1.0, 0.001).name('Saturation');
      fcol.add(p, 'val', 0.1, 2.0, 0.01).name('Value');
      fcol.open();


    } else if (kind === 'hexagon'){
      const p = currentViz.params || {};
      gui.add(p, 'speed', 0.1, 3.0, 0.01).name('Speed');
      gui.add(p, 'scaleA', 2.0, 16.0, 0.1).name('Scale A');
      gui.add(p, 'scaleB', 2.0, 16.0, 0.1).name('Scale B');
      gui.add(p, 'distort', 0.8, 2.0, 0.01).name('Distort');
      gui.add(p, 'redIntensity', 0.0, 2.0, 0.01).name('Color Intensity');
      gui.add(p, 'vignette', 0.05, 0.6, 0.005).name('Vignette');

	      // Zoom and texture controls for Hex Cells
	      gui.add(p, 'zoomOut', 3.0, 30.0, 0.1).name('Zoom Out');
	      gui.add(p, 'useTexture').name('Use Texture').onChange(v=> currentViz.params.useTexture = v);
	      gui.add(p, 'texMix', 0.0, 1.0, 0.01).name('Texture Mix');
	      gui.add(p, 'texScale', 0.5, 5.0, 0.01).name('Texture Scale');
	      const gc = document.getElementById('guiContainer');
	      const texRow = document.createElement('div'); texRow.className = 'row';
	      texRow.innerHTML = '<label>Hex Texture:</label><input type="file" id="hexTexInput" accept="image/*" />';
	      gc.appendChild(texRow);
	      document.getElementById('hexTexInput').addEventListener('change', (e)=>{
	        const file = e.target.files[0]; if (!file) return; const url = URL.createObjectURL(file);
	        if (currentViz && typeof currentViz.setTextureURL === 'function') { currentViz.setTextureURL(url); }
	      });

    } else if (kind === 'deform'){
      const p = currentViz.params || {};
      gui.add(p, 'amplitude', 0.0, 1.5, 0.01).name('Amplitude');
    } else if (kind === 'plasma'){
      // No parameters yet
    } else if (kind === 'lava'){
      const p = currentViz.params || {};

      // Flow controls
      const flowFolder = gui.addFolder('Flow');
      flowFolder.add(p, 'flowSpeed', 0.0, 3.0, 0.01).name('Flow Speed');
      flowFolder.add(p, 'flowIntensity', 0.0, 3.0, 0.01).name('Flow Intensity');
      flowFolder.add(p, 'spaceWarp', 0.0, 2.0, 0.01).name('Space Warp');
      flowFolder.add(p, 'rotationAmount', 0.0, 2.0, 0.01).name('Rotation');
      flowFolder.add(p, 'jitterAmount', 0.0, 2.0, 0.01).name('Jitter');
      flowFolder.open();

      // Visual controls
      const visualFolder = gui.addFolder('Visual');
      visualFolder.add(p, 'edgeIntensity', 0.0, 3.0, 0.01).name('Edge Intensity');
      visualFolder.add(p, 'colorSpeed', 0.0, 3.0, 0.01).name('Color Speed');
      visualFolder.open();

      // Audio reactivity
      const audioFolder = gui.addFolder('Audio Reactivity');
      audioFolder.add(p, 'bassReactivity', 0.0, 3.0, 0.01).name('Bass');
      audioFolder.add(p, 'midReactivity', 0.0, 3.0, 0.01).name('Mid');
      audioFolder.add(p, 'trebleReactivity', 0.0, 3.0, 0.01).name('Treble');
      audioFolder.open();
    } else if (kind === 'bars3d'){
      // No adjustable params without rebuild; could add read-only display
    } else if (kind === 'vertex'){
      // No parameters yet
    } else if (kind === 'grid'){
      const p = currentViz.params || {};
      gui.add(p, 'rotate', 0.0, 2.0, 0.01).name('Rotate');
    } else if (kind === 'ribbons'){
      const p = currentViz.params || {};
      gui.add(p, 'speed', 0.2, 2.5, 0.01).name('Speed');
      gui.add(p, 'spread', 0.5, 4.0, 0.01).name('Spread');
    } else if (kind === 'galaxy'){
      // No parameters yet (count requires rebuild)
    } else if (kind === 'feedback'){
      const p = currentViz.params || {};
      gui.add(p, 'decay', 0.90, 0.999, 0.0005).name('Decay');
      gui.add(p, 'addBase', 0.0, 0.5, 0.005).name('Add Base');
      gui.add(p, 'mulBase', 0.0, 0.5, 0.005).name('Mul Base');
      gui.add(p, 'segBase', 1.0, 16.0, 1.0).name('Segments Base');
      gui.add(p, 'segRange', 0.0, 24.0, 1.0).name('Segments Range');
      gui.add(p, 'spiralMax', 0.0, 3.0, 0.01).name('Spiral Max');
      gui.add(p, 'noiseTreble', 0.0, 0.05, 0.001).name('Noise Treble');
      gui.add(p, 'hueTimeSpeed', 0.0, 0.2, 0.005).name('Hue Speed');
      gui.add(p, 'gamma', 0.5, 2.0, 0.01).name('Gamma');
      gui.add(p, 'satBase', 0.0, 1.0, 0.01).name('Saturation Base');
      gui.add(p, 'patternMode', { Kaleidoscope:0, GridMirror:1, Voronoi:2, Hex:3, Triangles:4, SpiralGrid:5, Concentric:6, RadialSpokes:7, DrosteTunnel:8, Petals:9 }).name('Pattern');
      gui.add(p, 'gridScale', 1.0, 24.0, 0.1).name('Grid Scale');
      gui.add(p, 'patternRotate', 0.0, Math.PI*2, 0.01).name('Pattern Rotate');
      gui.add(p, 'patternOffsetX', -2.0, 2.0, 0.01).name('Pattern Offset X');
      gui.add(p, 'patternOffsetY', -2.0, 2.0, 0.01).name('Pattern Offset Y');
      gui.add(p, 'patternMorph', 0.0, 1.0, 0.01).name('Pattern Morph');

      gui.add(p, 'paletteMode', { Continuous:0, Quantized:1, Triadic:2, Complementary:3, Analogous:4, SplitComplementary:5, Tetradic:6, Monochrome:7 }).name('Palette');
      gui.add(p, 'hueSteps', 2.0, 24.0, 1.0).name('Hue Steps');
      gui.add(p, 'paletteIntensity', 0.3, 2.0, 0.01).name('Palette Intensity');
      gui.add(p, 'colorTemp', -0.5, 0.5, 0.01).name('Color Temp');

      gui.add(p, 'edgeStrength', 0.0, 1.0, 0.01).name('Edge Strength');
      gui.add(p, 'sharpen', 0.0, 1.0, 0.01).name('Sharpen');
      gui.add(p, 'contrast', 0.0, 1.5, 0.01).name('Contrast');
      gui.add(p, 'voronoiStrength', 0.0, 0.3, 0.001).name('Voronoi Warp');
      gui.add(p, 'rectWaveAmp', 0.0, 0.05, 0.001).name('Rect Wave Amp');
      gui.add(p, 'rectWaveFreq', 1.0, 30.0, 0.5).name('Rect Wave Freq');
      gui.add(p, 'zigzagAmp', 0.0, 0.05, 0.001).name('Zigzag Amp');
      gui.add(p, 'noiseWarpStrength', 0.0, 0.05, 0.001).name('Noise Warp');

      gui.add(p, 'brightness', 0.3, 1.5, 0.01).name('Brightness');
      gui.add(p, 'toneStrength', 0.0, 1.0, 0.01).name('Tone Map');
      gui.add(p, 'bassFloor', 0.0, 0.5, 0.01).name('Bass Floor');
      gui.add(p, 'midFloor', 0.0, 0.5, 0.01).name('Mid Floor');
      gui.add(p, 'trebleFloor', 0.0, 0.5, 0.01).name('Treble Floor');

      const rng = { randomize(){
        const p = currentViz.params || {};
        const rr = (min,max)=>min + Math.random()*(max-min);
        const ri = (min,max)=>Math.floor(min + Math.random()*(max-min+1));
        p.decay = rr(0.965, 0.992);
        p.decayBass = rr(0.0, 0.05);
        p.addBase = rr(0.00, 0.12);
        p.addTreble = rr(0.05, 0.50);
        p.mulBase = rr(0.00, 0.15);
        p.mulMid = rr(0.05, 0.35);
        p.segBase = Math.round(rr(3.0, 12.0));
        p.segRange = Math.round(rr(4.0, 20.0));
        p.spiralMin = rr(0.0, 0.2);
        p.spiralMax = rr(0.3, 2.0);
        p.noiseBase = rr(0.000, 0.006);
        p.noiseTreble = rr(0.003, 0.035);
        p.hueTimeSpeed = rr(0.0, 0.08);
        p.satBase = rr(0.10, 0.70);
        p.satMid = rr(0.05, 0.60);
        p.satTreble = rr(0.05, 0.60);
        p.gamma = rr(0.8, 1.4);
        p.brightness = rr(0.6, 1.2);
        p.toneStrength = rr(0.5, 1.0);
        p.bassFloor = rr(0.05, 0.25);
        p.midFloor = rr(0.05, 0.25);
        p.trebleFloor = rr(0.05, 0.25);
        // New pattern/palette randomization
        p.patternMode = ri(0, 6);
        p.gridScale = rr(2.0, 18.0);
        p.patternRotate = rr(0.0, Math.PI*2);
        p.patternOffsetX = rr(-0.8, 0.8);
        p.patternOffsetY = rr(-0.8, 0.8);
        p.patternMorph = rr(0.0, 1.0);
        p.paletteMode = ri(0, 7);
        p.hueSteps = ri(3, 16);
        p.paletteIntensity = rr(0.6, 1.6);
        p.colorTemp = rr(-0.3, 0.3);
        // Structure and warp extras
        p.edgeStrength = rr(0.0, 0.6);
        p.sharpen = rr(0.0, 0.6);
        p.contrast = rr(0.0, 0.6);
        p.voronoiStrength = rr(0.0, 0.2);
        p.rectWaveAmp = rr(0.0, 0.03);
        p.rectWaveFreq = rr(4.0, 22.0);
        p.zigzagAmp = rr(0.0, 0.02);
        p.noiseWarpStrength = rr(0.0, 0.02);
        if (gui && gui.__controllers) gui.__controllers.forEach(c=>c.updateDisplay&&c.updateDisplay());
      }};
      gui.add(rng, 'randomize').name('Randomize Params');

    } else if (kind === 'torusknot'){
      const p = currentViz.params || {};
      gui.add(p, 'textureSpeed', 0.2, 3.0, 0.05).name('Texture Speed').onChange(v=>currentViz.params.textureSpeed=v);
      gui.add(p, 'emissive', 0.0, 2.0, 0.01).name('Emissive').onChange(v=>currentViz.material.emissiveIntensity=v);
    } else if (kind === 'scatter'){
      const p = currentViz.params || {};
      gui.add(p, 'rotate', 0.0, 2.0, 0.01).name('Rotate');
    } else if (kind === 'lensflares'){
      const p = currentViz.params || {};
      gui.add(p, 'intensity', 0.2, 4.0, 0.05).name('Intensity').onChange(v=>{ currentViz.params.intensity = v; currentViz.light.intensity = v; });
    } else if (kind === 'spotlights'){
      const p = currentViz.params || {};
      gui.add(p, 'angle', 0.1, 1.2, 0.01).name('Angle').onChange(v=> currentViz.params.angle = v);
      gui.add(p, 'penumbra', 0.0, 1.0, 0.01).name('Penumbra').onChange(v=> currentViz.params.penumbra = v);
    }
  }

  function updateMetrics(){
    // FPS
    fpsFrames++;
    const now = performance.now();
    if (now - fpsLast > 1000){
      const fps = Math.round((fpsFrames * 1000) / (now - fpsLast));
      fpsEl.textContent = 'FPS: ' + fps;
      fpsFrames = 0; fpsLast = now;
    }

    // Audio levels
    if (currentViz && currentViz.analyser && currentViz.frequencyData){
      currentViz.analyser.getByteFrequencyData(currentViz.frequencyData);
      const b = currentViz._computeBands(currentViz.frequencyData, currentViz.fftSize, currentViz.sampleRate);
      bassBar.style.width = Math.round(b.bass * 100) + '%';
      midBar.style.width = Math.round(b.mid * 100) + '%';
      trebleBar.style.width = Math.round(b.treble * 100) + '%';
    }

    // Stats
    if (currentViz && typeof currentViz.getStats === 'function'){
      const s = currentViz.getStats();
      countEl.textContent = 'Count: ' + (s.particles ?? '--');
    }
    requestAnimationFrame(updateMetrics);
  }

  // UI wiring
  vizSelect.addEventListener('change', async e => { await createViz(e.target.value); });
  micBtn.addEventListener('click', async ()=>{
    await AudioCtrl.useMic();
    if (!currentViz) await createViz(vizSelect.value);
    if (AudioCtrl.ctx && AudioCtrl.ctx.state === 'suspended') await AudioCtrl.ctx.resume();
    currentViz.setAnalyser(AudioCtrl.ctx, AudioCtrl.analyser, AudioCtrl.fftSize);
    currentViz.start();
  });
  fileInput.addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if (!file) return;
    const url = URL.createObjectURL(file);
    audioEl.src = url; audioEl.loop = true;
    await audioEl.play().catch(()=>{});
    await AudioCtrl.useFile(audioEl);
    if (!currentViz) await createViz(vizSelect.value);
    if (AudioCtrl.ctx && AudioCtrl.ctx.state === 'suspended') await AudioCtrl.ctx.resume();
    currentViz.setAnalyser(AudioCtrl.ctx, AudioCtrl.analyser, AudioCtrl.fftSize);
    currentViz.start();
  });
  fullscreenBtn.addEventListener('click', ()=>{
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  });

  // Boot
  (async () => {
    vizSelect.value = 'feedback';
    await createViz(vizSelect.value);
    updateMetrics();
  })();
</script>
</body>
</html>

